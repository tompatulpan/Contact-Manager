<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple/iCloud vCard Import/Export Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { border-left: 4px solid #4CAF50; background: #f8fff8; }
        .error { border-left: 4px solid #f44336; background: #fff8f8; }
        .info { border-left: 4px solid #2196F3; background: #f8f9ff; }
        .apple-badge {
            background: #007AFF;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .output {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .contact-display {
            border: 1px solid #007AFF;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            background: #f8f9ff;
        }
        .contact-field {
            margin: 5px 0;
        }
        .field-label {
            font-weight: bold;
            color: #333;
        }
        .field-value {
            color: #666;
            margin-left: 10px;
        }
        .export-options {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçé Apple/iCloud vCard Import/Export Test</h1>
        <p>Test importing Apple/iCloud vCard 3.0 format and exporting to both standard vCard 4.0 and Apple-compatible formats.</p>
    </div>

    <div class="container">
        <h2>üì• Import Apple/iCloud vCard</h2>
        <div class="test-section info">
            <h3>Sample Apple/iCloud vCard 3.0 <span class="apple-badge">3.0</span></h3>
            <textarea id="appleVCardInput">BEGIN:VCARD
VERSION:3.0
FN:Adam Adamsson
N:Adamsson;Adam;;;
EMAIL;type=HOME;pref:adam@test.com
TEL;type=WORK;pref:+46 70-111 22 33
TEL;type=MOBILE:+46 73-444 55 66
URL;type=PERSONAL;pref:https://test.org
URL;type=OTHER:https://mytest.org
URL;type=SOCIAL;pref:https://signal.me/#eu/w4jmZHwXAV7M4vYVbgTNoiNgzbPNx0cFRGsovBaqv-oLIU
URL;type=SOCIAL:https://mastodon.acc.sunet.se/@adam
URL;type=OTHER:https://www.linkedin.com/in/adam-adamsson-67834040/
ADR:;;Street 123;City;;12345;
END:VCARD</textarea>
            <button onclick="importAppleVCard()">Import Apple vCard</button>
            <button onclick="loadDifferentAppleCard()">Load Different Sample</button>
        </div>

        <div id="importResult" class="test-section" style="display: none;">
            <h3>Import Result</h3>
            <div id="importOutput" class="output"></div>
            <div id="contactDisplay" class="contact-display"></div>
        </div>
    </div>

    <div class="container">
        <h2>üì§ Export Options</h2>
        <div id="exportSection" style="display: none;">
            <div class="export-options">
                <button onclick="exportAsStandard()">Export as vCard 4.0 (Standard)</button>
                <button onclick="exportAsApple()">Export as Apple vCard 3.0</button>
                <button onclick="showComparison()">Compare Formats</button>
            </div>

            <div id="exportResults"></div>
        </div>
    </div>

    <div class="container">
        <h2>üîç Format Detection Test</h2>
        <div class="test-section info">
            <h3>Test Format Detection</h3>
            <textarea id="detectionInput" placeholder="Paste any vCard here to test format detection..."></textarea>
            <button onclick="detectFormat()">Detect Format</button>
            <div id="detectionResult" class="output"></div>
        </div>
    </div>

    <script type="module">
        import { VCardStandard } from './src/core/VCardStandard.js';

        // Initialize vCard processor
        const vCardStandard = new VCardStandard();
        let currentContact = null;

        // Make functions globally available
        window.vCardStandard = vCardStandard;
        window.currentContact = null;

        window.importAppleVCard = function() {
            const vCardInput = document.getElementById('appleVCardInput').value;
            
            try {
                console.log('üçé Testing Apple vCard import...');
                
                // Import the Apple vCard
                const contact = vCardStandard.importFromVCard(vCardInput, 'Apple Import Test');
                window.currentContact = contact;
                
                // Display results
                document.getElementById('importResult').style.display = 'block';
                document.getElementById('importOutput').textContent = JSON.stringify(contact, null, 2);
                
                // Display contact in user-friendly format
                displayContact(contact);
                
                // Show export section
                document.getElementById('exportSection').style.display = 'block';
                
                console.log('‚úÖ Apple vCard imported successfully!', contact);
                
            } catch (error) {
                console.error('‚ùå Apple vCard import failed:', error);
                document.getElementById('importResult').style.display = 'block';
                document.getElementById('importResult').className = 'test-section error';
                document.getElementById('importOutput').textContent = `Error: ${error.message}`;
            }
        };

        window.loadDifferentAppleCard = function() {
            const sampleCard2 = `BEGIN:VCARD
VERSION:3.0
FN:John Smith
N:Smith;John;Michael;;
EMAIL;type=WORK;pref:john.smith@company.com
EMAIL;type=HOME:john@personal.com
TEL;type=WORK:+1-555-123-4567
TEL;type=MOBILE;pref:+1-555-987-6543
URL;type=WORK;pref:https://company.com
URL;type=SOCIAL:https://linkedin.com/in/johnsmith
URL;type=PERSONAL:https://johnsmith.com
ORG:Example Corp
TITLE:Senior Developer
ADR:;;123 Main St;Anytown;CA;12345;USA
END:VCARD`;
            
            document.getElementById('appleVCardInput').value = sampleCard2;
        };

        window.displayContact = function(contact) {
            const displayData = vCardStandard.extractDisplayData(contact);
            const displayDiv = document.getElementById('contactDisplay');
            
            let html = `
                <h4>üì± Contact: ${displayData.fullName}</h4>
                <div class="contact-field">
                    <span class="field-label">Card Name:</span>
                    <span class="field-value">${contact.cardName}</span>
                </div>
                <div class="contact-field">
                    <span class="field-label">Contact ID:</span>
                    <span class="field-value">${contact.contactId}</span>
                </div>
                <div class="contact-field">
                    <span class="field-label">Import Source:</span>
                    <span class="field-value">${contact.metadata.importSource || 'standard'}</span>
                </div>
            `;
            
            if (displayData.phones && displayData.phones.length > 0) {
                html += '<div class="contact-field"><span class="field-label">Phone Numbers:</span></div>';
                displayData.phones.forEach(phone => {
                    html += `<div class="field-value">üìû ${phone.value} (${phone.type}${phone.primary ? ', primary' : ''})</div>`;
                });
            }
            
            if (displayData.emails && displayData.emails.length > 0) {
                html += '<div class="contact-field"><span class="field-label">Email Addresses:</span></div>';
                displayData.emails.forEach(email => {
                    html += `<div class="field-value">üìß ${email.value} (${email.type}${email.primary ? ', primary' : ''})</div>`;
                });
            }
            
            if (displayData.urls && displayData.urls.length > 0) {
                html += '<div class="contact-field"><span class="field-label">URLs:</span></div>';
                displayData.urls.forEach(url => {
                    html += `<div class="field-value">üåê <a href="${url.value}" target="_blank">${url.value}</a> (${url.type}${url.primary ? ', primary' : ''})</div>`;
                });
            }
            
            if (displayData.organization) {
                html += `<div class="contact-field">
                    <span class="field-label">Organization:</span>
                    <span class="field-value">${displayData.organization}</span>
                </div>`;
            }
            
            if (displayData.title) {
                html += `<div class="contact-field">
                    <span class="field-label">Title:</span>
                    <span class="field-value">${displayData.title}</span>
                </div>`;
            }
            
            displayDiv.innerHTML = html;
        };

        window.exportAsStandard = function() {
            if (!window.currentContact) {
                alert('Please import a contact first!');
                return;
            }
            
            const exportData = vCardStandard.exportAsVCard(window.currentContact);
            showExportResult('Standard vCard 4.0', exportData, 'standard');
        };

        window.exportAsApple = function() {
            if (!window.currentContact) {
                alert('Please import a contact first!');
                return;
            }
            
            const exportData = vCardStandard.exportAsAppleVCard(window.currentContact);
            showExportResult('Apple vCard 3.0', exportData, 'apple');
        };

        window.showExportResult = function(title, exportData, type) {
            const resultsDiv = document.getElementById('exportResults');
            
            const resultHTML = `
                <div class="test-section ${type === 'apple' ? 'info' : 'success'}">
                    <h4>${title} ${type === 'apple' ? '<span class="apple-badge">3.0</span>' : '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">4.0</span>'}</h4>
                    <p><strong>Filename:</strong> ${exportData.filename}</p>
                    <p><strong>MIME Type:</strong> ${exportData.mimeType}</p>
                    ${exportData.format ? `<p><strong>Format:</strong> ${exportData.format}</p>` : ''}
                    <h5>Content:</h5>
                    <div class="output">${exportData.content}</div>
                    <button onclick="downloadFile('${exportData.filename}', '${exportData.content}', '${exportData.mimeType}')">
                        Download File
                    </button>
                </div>
            `;
            
            resultsDiv.innerHTML += resultHTML;
        };

        window.showComparison = function() {
            if (!window.currentContact) {
                alert('Please import a contact first!');
                return;
            }
            
            const standardExport = vCardStandard.exportAsVCard(window.currentContact);
            const appleExport = vCardStandard.exportAsAppleVCard(window.currentContact);
            
            const comparisonHTML = `
                <div class="test-section info">
                    <h4>üìä Format Comparison</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h5>Standard vCard 4.0 <span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">4.0</span></h5>
                            <div class="output" style="height: 300px; overflow-y: auto;">${standardExport.content}</div>
                        </div>
                        <div>
                            <h5>Apple vCard 3.0 <span class="apple-badge">3.0</span></h5>
                            <div class="output" style="height: 300px; overflow-y: auto;">${appleExport.content}</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 4px;">
                        <h6>Key Differences:</h6>
                        <ul>
                            <li><strong>Version:</strong> 4.0 vs 3.0</li>
                            <li><strong>Parameter syntax:</strong> TYPE=work vs type=WORK</li>
                            <li><strong>URL types:</strong> Standard (work/home/other) vs Apple (PERSONAL/SOCIAL/OTHER)</li>
                            <li><strong>Preference syntax:</strong> PREF=1 vs pref</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('exportResults').innerHTML = comparisonHTML;
        };

        window.detectFormat = function() {
            const input = document.getElementById('detectionInput').value;
            const resultDiv = document.getElementById('detectionResult');
            
            if (!input.trim()) {
                resultDiv.textContent = 'Please enter a vCard to test format detection.';
                return;
            }
            
            try {
                const isApple = vCardStandard.isAppleVCard(input);
                const version = vCardStandard.extractVersion(input);
                
                let result = `Format Detection Results:\n\n`;
                result += `Detected Version: ${version || 'Unknown'}\n`;
                result += `Is Apple/iCloud Format: ${isApple ? 'Yes üçé' : 'No'}\n`;
                result += `Recommended Import Method: ${isApple ? 'importFromAppleVCard()' : 'importFromVCard()'}\n\n`;
                
                if (isApple) {
                    result += `Apple Format Indicators Found:\n`;
                    if (input.includes('VERSION:3.0')) result += '- VERSION:3.0 ‚úì\n';
                    if (input.includes('type=')) result += '- Lowercase "type=" parameters ‚úì\n';
                    if (input.includes('TYPE=PERSONAL')) result += '- Apple URL type "PERSONAL" ‚úì\n';
                    if (input.includes('TYPE=SOCIAL')) result += '- Apple URL type "SOCIAL" ‚úì\n';
                }
                
                resultDiv.textContent = result;
                
            } catch (error) {
                resultDiv.textContent = `Error during detection: ${error.message}`;
            }
        };

        window.downloadFile = function(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        };

        // Auto-load on page ready
        console.log('üçé Apple/iCloud vCard Test Page Ready');
        console.log('VCardStandard loaded:', vCardStandard);
    </script>
</body>
</html>