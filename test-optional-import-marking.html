<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Optional Import Marking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-import { background: #4CAF50; color: white; }
        .btn-import-unmarked { background: #FF9800; color: white; }
        .btn-create { background: #2196F3; color: white; }
        .btn-clear { background: #f44336; color: white; }
        .contact-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .contact-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            background: #f8f8f8;
        }
        .imported-contact {
            background: #e8f5e8;
            border-color: #4CAF50;
        }
        .owned-contact {
            background: #e8f0ff;
            border-color: #2196F3;
        }
        .shared-contact {
            background: #fff3e0;
            border-color: #FF9800;
        }
        .contact-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .contact-metadata {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }
        .filter-section {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .checkbox-item {
            display: inline-block;
            margin-right: 20px;
        }
        .log {
            background: #f9f9f9;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>Test Optional Import Marking</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <div class="test-controls">
            <button class="btn-import" onclick="importWithMarking()">Import with "Imported Files" marking</button>
            <button class="btn-import-unmarked" onclick="importWithoutMarking()">Import without marking</button>
            <button class="btn-create" onclick="createNormalContact()">Create Normal Contact</button>
            <button class="btn-clear" onclick="clearAll()">Clear All</button>
        </div>
    </div>

    <div class="filter-section">
        <h3>Filters</h3>
        <label class="checkbox-item">
            <input type="checkbox" id="filter-owned" checked onchange="updateDisplay()">
            My Contacts
        </label>
        <label class="checkbox-item">
            <input type="checkbox" id="filter-shared" checked onchange="updateDisplay()">
            Shared with Me
        </label>
        <label class="checkbox-item">
            <input type="checkbox" id="filter-imported" onchange="updateDisplay()">
            Imported Files
        </label>
        <label class="checkbox-item">
            <input type="checkbox" id="filter-archived" onchange="updateDisplay()">
            Archived
        </label>
    </div>

    <div class="test-section">
        <h3>Contact List</h3>
        <div id="contact-list" class="contact-list">
            <!-- Contacts will be displayed here -->
        </div>
    </div>

    <div class="test-section">
        <h3>Debug Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        import { ContactManager } from './src/core/ContactManager.js';
        import { ContactDatabase } from './src/core/ContactDatabase.js';
        import { VCardStandard } from './src/core/VCardStandard.js';
        import { EventBus } from './src/utils/EventBus.js';

        // Initialize components
        const eventBus = new EventBus();
        const database = new ContactDatabase(eventBus);
        const contactManager = new ContactManager(eventBus, database);
        const vCardStandard = new VCardStandard();

        let counter = 1;

        // Make functions global for button access
        window.importWithMarking = async function() {
            const sampleVCard = createSampleVCard(`Imported Contact ${counter} (MARKED)`);
            try {
                log(`üì• Importing contact WITH "Imported Files" marking...`);
                const contact = vCardStandard.importFromVCard(sampleVCard, null, true); // markAsImported = true
                await database.saveContact(contact);
                contactManager.contacts.set(contact.contactId, contact);
                
                log(`‚úÖ Imported: ${contact.cardName}`);
                log(`üìã isImported: ${contact.metadata.isImported === true ? 'YES' : 'NO'}`);
                counter++;
                updateDisplay();
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        };

        window.importWithoutMarking = async function() {
            const sampleVCard = createSampleVCard(`Imported Contact ${counter} (UNMARKED)`);
            try {
                log(`üì• Importing contact WITHOUT "Imported Files" marking...`);
                const contact = vCardStandard.importFromVCard(sampleVCard, null, false); // markAsImported = false
                await database.saveContact(contact);
                contactManager.contacts.set(contact.contactId, contact);
                
                log(`‚úÖ Imported: ${contact.cardName}`);
                log(`üìã isImported: ${contact.metadata.isImported === true ? 'YES' : 'NO'}`);
                counter++;
                updateDisplay();
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        };

        window.createNormalContact = async function() {
            try {
                log(`üë§ Creating normal contact...`);
                const contactData = {
                    fullName: `Normal Contact ${counter}`,
                    cardName: `Normal Contact ${counter}`,
                    phones: [{ value: `555-000-${counter.toString().padStart(4, '0')}`, type: 'mobile' }],
                    emails: [{ value: `normal${counter}@example.com`, type: 'home' }]
                };
                
                const result = await contactManager.createContact(contactData);
                if (result.success) {
                    log(`‚úÖ Created: ${result.contact.cardName}`);
                    log(`üìã isImported: ${result.contact.metadata.isImported === true ? 'YES' : 'NO'}`);
                    counter++;
                    updateDisplay();
                } else {
                    log(`‚ùå Failed: ${result.error}`);
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        };

        window.clearAll = function() {
            contactManager.contacts.clear();
            counter = 1;
            log(`üóëÔ∏è Cleared all contacts`);
            updateDisplay();
        };

        window.updateDisplay = function() {
            displayContacts();
        };

        function createSampleVCard(name) {
            return `BEGIN:VCARD
VERSION:4.0
FN:${name}
TEL;TYPE=work:555-100-${counter.toString().padStart(4, '0')}
EMAIL;TYPE=work:test${counter}@company.com
ORG:Test Company
END:VCARD`;
        }

        function getCurrentFilters() {
            const ownedChecked = document.getElementById('filter-owned').checked;
            const sharedChecked = document.getElementById('filter-shared').checked;
            const importedChecked = document.getElementById('filter-imported').checked;
            const archivedChecked = document.getElementById('filter-archived').checked;

            const filters = {
                includeDeleted: false,
                includeArchived: archivedChecked
            };

            // Handle imported-only filter
            if (importedChecked && !ownedChecked && !sharedChecked && !archivedChecked) {
                filters.importedOnly = true;
            }
            // Handle combinations with imported
            else if (importedChecked) {
                filters.includeImported = true;
                if (ownedChecked && !sharedChecked) {
                    filters.ownership = 'owned';
                } else if (!ownedChecked && sharedChecked) {
                    filters.ownership = 'shared';
                }
            }
            // Handle standard ownership filters (excluding imported)
            else if (ownedChecked && !sharedChecked) {
                filters.ownership = 'owned';
            } else if (!ownedChecked && sharedChecked) {
                filters.ownership = 'shared';
            }

            return filters;
        }

        function displayContacts() {
            const filters = getCurrentFilters();
            const allContacts = Array.from(contactManager.contacts.values());
            const filteredContacts = contactManager.applyFilters(allContacts, filters);
            
            const container = document.getElementById('contact-list');
            
            if (filteredContacts.length === 0) {
                container.innerHTML = '<p>No contacts found with current filters.</p>';
                return;
            }

            container.innerHTML = filteredContacts.map(contact => {
                const isImported = contact.metadata.isImported === true;
                const isOwned = contact.metadata.isOwned === true;
                
                let cssClass = 'contact-item';
                let typeLabel = '';
                let backgroundColor = '';
                
                if (isImported) {
                    cssClass += ' imported-contact';
                    typeLabel = '[IMPORTED FILE]';
                    backgroundColor = 'Light Green';
                } else if (isOwned) {
                    cssClass += ' owned-contact';
                    typeLabel = '[MY CONTACT]';
                    backgroundColor = 'Light Blue';
                } else {
                    cssClass += ' shared-contact';
                    typeLabel = '[SHARED]';
                    backgroundColor = 'Light Orange';
                }

                return `
                    <div class="${cssClass}">
                        <div class="contact-header">${contact.cardName} ${typeLabel}</div>
                        <div class="contact-metadata">
                            <strong>Contact ID:</strong> ${contact.contactId}<br>
                            <strong>Background:</strong> ${backgroundColor}<br>
                            <strong>isOwned:</strong> ${contact.metadata.isOwned}<br>
                            <strong>isImported:</strong> ${contact.metadata.isImported === true ? 'YES' : 'NO'}<br>
                            <strong>Created:</strong> ${new Date(contact.metadata.createdAt).toLocaleTimeString()}
                        </div>
                    </div>
                `;
            }).join('');

            log(`üìä Displayed ${filteredContacts.length} contacts (${allContacts.length} total)`);
        }

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // Initialize
        log(`üöÄ Optional import marking test initialized`);
        displayContacts();
    </script>
</body>
</html>