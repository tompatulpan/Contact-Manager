<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Import Filtering</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .filter-controls {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            background: #f9f9f9;
        }
        .checkbox-item {
            display: block;
            margin: 10px 0;
        }
        .contact-list {
            margin: 20px 0;
        }
        .contact-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #eee;
            background: #f8f8f8;
        }
        .imported-contact {
            background: #e8f5e8;
            border-color: #4CAF50;
        }
        .owned-contact {
            background: #e8f0ff;
            border-color: #2196F3;
        }
        .shared-contact {
            background: #fff3e0;
            border-color: #FF9800;
        }
        .archived-contact {
            background: #f0f0f0;
            border-color: #999;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-import { background: #4CAF50; color: white; }
        .btn-create { background: #2196F3; color: white; }
        .btn-archive { background: #999; color: white; }
        .log {
            background: #f0f0f0;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Test Import Filtering Functionality</h1>
    
    <div class="test-section">
        <h2>Test Actions</h2>
        <button class="btn-create" onclick="createNormalContact()">Create Normal Contact</button>
        <button class="btn-import" onclick="importVCardContact()">Import vCard Contact</button>
        <button class="btn-archive" onclick="archiveFirstContact()">Archive First Contact</button>
        <button onclick="clearContacts()">Clear All Contacts</button>
    </div>

    <div class="filter-controls">
        <h3>Filter Controls</h3>
        <label class="checkbox-item">
            <input type="checkbox" id="filter-owned" checked onchange="updateFilters()">
            My Contacts
        </label>
        <label class="checkbox-item">
            <input type="checkbox" id="filter-shared" checked onchange="updateFilters()">
            Shared with Me
        </label>
        <label class="checkbox-item">
            <input type="checkbox" id="filter-imported" onchange="updateFilters()">
            Imported Files
        </label>
        <label class="checkbox-item">
            <input type="checkbox" id="filter-archived" onchange="updateFilters()">
            Archived
        </label>
    </div>

    <div class="test-section">
        <h3>Contact List</h3>
        <div id="contact-list" class="contact-list">
            <!-- Contacts will be displayed here -->
        </div>
    </div>

    <div class="test-section">
        <h3>Debug Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        import { ContactManager } from './src/core/ContactManager.js';
        import { ContactDatabase } from './src/core/ContactDatabase.js';
        import { VCardStandard } from './src/core/VCardStandard.js';
        import { ContactValidator } from './src/core/ContactValidator.js';
        import { EventBus } from './src/utils/EventBus.js';

        // Initialize components
        const eventBus = new EventBus();
        const database = new ContactDatabase(eventBus);
        const contactManager = new ContactManager(eventBus, database);

        let contactCounter = 1;

        // Make functions global for button access
        window.createNormalContact = async function() {
            try {
                const contactData = {
                    fullName: `Test Contact ${contactCounter}`,
                    cardName: `Test Contact ${contactCounter}`,
                    phones: [{ value: `555-000-${contactCounter.toString().padStart(4, '0')}`, type: 'mobile' }],
                    emails: [{ value: `test${contactCounter}@example.com`, type: 'home' }]
                };
                
                const result = await contactManager.createContact(contactData);
                contactCounter++;
                
                if (result.success) {
                    log(`‚úÖ Created normal contact: ${result.contact.cardName}`);
                    displayContacts();
                } else {
                    log(`‚ùå Failed to create contact: ${result.error}`);
                }
            } catch (error) {
                log(`‚ùå Error creating contact: ${error.message}`);
            }
        };

        window.importVCardContact = async function() {
            try {
                const sampleVCard = `BEGIN:VCARD
VERSION:4.0
FN:Imported Contact ${contactCounter}
TEL;TYPE=work:555-100-${contactCounter.toString().padStart(4, '0')}
EMAIL;TYPE=work:imported${contactCounter}@company.com
ORG:Test Company
END:VCARD`;

                const result = await contactManager.importContactFromVCard(sampleVCard, `Imported Contact ${contactCounter}`);
                contactCounter++;
                
                if (result.success) {
                    log(`‚úÖ Imported vCard contact: ${result.contact.cardName}`);
                    log(`üìã Contact metadata:`, JSON.stringify(result.contact.metadata, null, 2));
                    displayContacts();
                } else {
                    log(`‚ùå Failed to import contact: ${result.error}`);
                }
            } catch (error) {
                log(`‚ùå Error importing contact: ${error.message}`);
            }
        };

        window.archiveFirstContact = async function() {
            try {
                const contacts = contactManager.getAllContacts();
                if (contacts.length === 0) {
                    log(`‚ùå No contacts to archive`);
                    return;
                }

                const firstContact = contacts[0];
                const result = await contactManager.archiveContact(firstContact.contactId);
                
                if (result.success) {
                    log(`‚úÖ Archived contact: ${firstContact.cardName}`);
                    displayContacts();
                } else {
                    log(`‚ùå Failed to archive contact: ${result.error}`);
                }
            } catch (error) {
                log(`‚ùå Error archiving contact: ${error.message}`);
            }
        };

        window.clearContacts = function() {
            contactManager.contacts.clear();
            contactCounter = 1;
            log(`üóëÔ∏è Cleared all contacts`);
            displayContacts();
        };

        window.updateFilters = function() {
            log(`üîß Filters updated`);
            displayContacts();
        };

        function getCurrentFilters() {
            const ownedChecked = document.getElementById('filter-owned').checked;
            const sharedChecked = document.getElementById('filter-shared').checked;
            const importedChecked = document.getElementById('filter-imported').checked;
            const archivedChecked = document.getElementById('filter-archived').checked;

            const filters = {
                includeDeleted: false,
                includeArchived: archivedChecked
            };

            // Handle imported-only filter
            if (importedChecked && !ownedChecked && !sharedChecked && !archivedChecked) {
                filters.importedOnly = true;
            }
            // Handle combinations with imported
            else if (importedChecked) {
                filters.includeImported = true;
                if (ownedChecked && !sharedChecked) {
                    filters.ownership = 'owned';
                } else if (!ownedChecked && sharedChecked) {
                    filters.ownership = 'shared';
                }
            }
            // Handle standard ownership filters (excluding imported)
            else if (ownedChecked && !sharedChecked) {
                filters.ownership = 'owned';
            } else if (!ownedChecked && sharedChecked) {
                filters.ownership = 'shared';
            }

            return filters;
        }

        function displayContacts() {
            const filters = getCurrentFilters();
            const filteredContacts = contactManager.searchContacts('', filters);
            
            const container = document.getElementById('contact-list');
            
            if (filteredContacts.length === 0) {
                container.innerHTML = '<p>No contacts found with current filters.</p>';
                return;
            }

            container.innerHTML = filteredContacts.map(contact => {
                const isImported = contact.metadata.isImported === true;
                const isArchived = contact.metadata.isArchived === true;
                const isOwned = contact.metadata.isOwned === true;
                
                let cssClass = 'contact-item';
                let typeLabel = '';
                
                if (isImported) {
                    cssClass += ' imported-contact';
                    typeLabel = '[IMPORTED]';
                } else if (isOwned) {
                    cssClass += ' owned-contact';
                    typeLabel = '[OWNED]';
                } else {
                    cssClass += ' shared-contact';
                    typeLabel = '[SHARED]';
                }
                
                if (isArchived) {
                    cssClass += ' archived-contact';
                    typeLabel += ' [ARCHIVED]';
                }

                return `
                    <div class="${cssClass}">
                        <strong>${contact.cardName}</strong> ${typeLabel}
                        <br><small>ID: ${contact.contactId}</small>
                        <br><small>Created: ${contact.metadata.createdAt}</small>
                        ${isImported ? '<br><small>‚ú® Marked as imported</small>' : ''}
                    </div>
                `;
            }).join('');

            log(`üìä Displayed ${filteredContacts.length} contacts with filters:`, JSON.stringify(filters, null, 2));
        }

        function log(message, data = null) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}${data ? '\\n' + JSON.stringify(data, null, 2) : ''}\\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message, data);
        }

        // Initialize
        log(`üöÄ Test page initialized`);
        displayContacts();
    </script>
</body>
</html>