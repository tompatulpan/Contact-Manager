<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribution List Sharing Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        .button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        #log { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            padding: 10px; 
            margin-top: 20px; 
            height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
        }
        .step { margin: 10px 0; }
        .step-title { font-weight: bold; color: #495057; }
    </style>
</head>
<body>
    <h1>Distribution List Sharing Fix Test</h1>
    <p>This test verifies that adding a new user to an existing distribution list properly shares previously shared contacts.</p>

    <div class="test-section">
        <h3>Test Scenario</h3>
        <p><strong>Scenario:</strong> user1 creates distribution list with user2, shares contact, then adds user3 to the list.</p>
        <p><strong>Expected:</strong> user3 should receive the previously shared contact.</p>
        
        <div class="step">
            <div class="step-title">Step 1: Create a test contact</div>
            <button class="button" onclick="createTestContact()">Create Test Contact</button>
            <span id="contact-status"></span>
        </div>
        
        <div class="step">
            <div class="step-title">Step 2: Create distribution list with user2</div>
            <input type="text" id="user2-input" placeholder="Enter user2 username" value="testuser2">
            <button class="button" onclick="createDistributionList()">Create List</button>
            <span id="list-status"></span>
        </div>
        
        <div class="step">
            <div class="step-title">Step 3: Share contact with distribution list</div>
            <button class="button" onclick="shareWithList()">Share Contact</button>
            <span id="share-status"></span>
        </div>
        
        <div class="step">
            <div class="step-title">Step 4: Add user3 to the distribution list</div>
            <input type="text" id="user3-input" placeholder="Enter user3 username" value="testuser3">
            <button class="button" onclick="addUserToList()">Add User3 to List</button>
            <span id="add-user-status"></span>
        </div>
        
        <div class="step">
            <div class="step-title">Step 5: Share contact with updated list (should share with user3)</div>
            <button class="button" onclick="shareWithUpdatedList()">Share with Updated List</button>
            <span id="final-share-status"></span>
        </div>
    </div>

    <div class="test-section">
        <h3>Debug Information</h3>
        <button class="button" onclick="checkDatabases()">Check Shared Databases</button>
        <button class="button" onclick="clearLog()">Clear Log</button>
    </div>

    <div id="log"></div>

    <script src="lib/userbase.js"></script>
    <script src="src/utils/EventBus.js"></script>
    <script src="src/core/VCardStandard.js"></script>
    <script src="src/core/ContactValidator.js"></script>
    <script src="src/core/ContactDatabase.js"></script>
    <script src="src/core/ContactManager.js"></script>

    <script>
        // Test variables
        let testContact = null;
        let testListName = 'test-sharing-fix-list';
        let contactManager = null;

        // Initialize
        async function init() {
            try {
                log('üöÄ Initializing test environment...');
                
                // Initialize Userbase
                await userbase.init({ appId: 'e74aaec7-9d60-495b-bf18-e4cd3de8a748' });
                log('‚úÖ Userbase initialized');

                // Check if user is signed in
                const session = userbase.getSession();
                if (!session?.user) {
                    log('‚ùå No user session found. Please sign in first.');
                    return;
                }

                log(`üë§ Signed in as: ${session.user.username}`);

                // Initialize contact manager
                const eventBus = new EventBus();
                contactManager = new ContactManager(eventBus);
                await contactManager.init();
                
                log('‚úÖ Contact manager initialized');
                log('üéØ Ready to test distribution list sharing fix!');
                
            } catch (error) {
                log(`‚ùå Initialization error: ${error.message}`, 'error');
            }
        }

        async function createTestContact() {
            try {
                log('üìû Creating test contact...');
                
                const contactData = {
                    cardName: 'Test Sharing Contact',
                    fn: 'John Test User',
                    phones: [{ value: '+1-555-123-4567', type: 'work' }],
                    emails: [{ value: 'john.test@company.com', type: 'work' }]
                };

                const result = await contactManager.createContact(contactData);
                if (result.success) {
                    testContact = result.contact;
                    log(`‚úÖ Test contact created: ${testContact.contactId}`);
                    document.getElementById('contact-status').innerHTML = '<span class="success">‚úÖ Created</span>';
                } else {
                    log(`‚ùå Failed to create contact: ${result.error}`, 'error');
                    document.getElementById('contact-status').innerHTML = '<span class="error">‚ùå Failed</span>';
                }
            } catch (error) {
                log(`‚ùå Create contact error: ${error.message}`, 'error');
                document.getElementById('contact-status').innerHTML = '<span class="error">‚ùå Error</span>';
            }
        }

        async function createDistributionList() {
            try {
                const user2 = document.getElementById('user2-input').value.trim();
                if (!user2) {
                    log('‚ùå Please enter user2 username', 'error');
                    return;
                }

                log(`üë• Creating distribution list with user2: ${user2}...`);
                
                const result = await contactManager.createDistributionList({
                    name: testListName,
                    description: 'Test list for sharing fix',
                    usernames: [user2]
                });

                if (result.success) {
                    log(`‚úÖ Distribution list created: ${testListName}`);
                    document.getElementById('list-status').innerHTML = '<span class="success">‚úÖ Created</span>';
                } else {
                    log(`‚ùå Failed to create list: ${result.error}`, 'error');
                    document.getElementById('list-status').innerHTML = '<span class="error">‚ùå Failed</span>';
                }
            } catch (error) {
                log(`‚ùå Create list error: ${error.message}`, 'error');
                document.getElementById('list-status').innerHTML = '<span class="error">‚ùå Error</span>';
            }
        }

        async function shareWithList() {
            try {
                if (!testContact) {
                    log('‚ùå No test contact available. Create one first.', 'error');
                    return;
                }

                log(`üì§ Sharing contact ${testContact.contactId} with list ${testListName}...`);
                
                const result = await contactManager.shareContactWithDistributionList(
                    testContact.contactId, 
                    testListName
                );

                if (result.success) {
                    log(`‚úÖ Contact shared with list: ${result.successCount} users, ${result.errorCount} errors`);
                    document.getElementById('share-status').innerHTML = '<span class="success">‚úÖ Shared</span>';
                } else {
                    log(`‚ùå Failed to share: ${result.error}`, 'error');
                    document.getElementById('share-status').innerHTML = '<span class="error">‚ùå Failed</span>';
                }
            } catch (error) {
                log(`‚ùå Share error: ${error.message}`, 'error');
                document.getElementById('share-status').innerHTML = '<span class="error">‚ùå Error</span>';
            }
        }

        async function addUserToList() {
            try {
                const user3 = document.getElementById('user3-input').value.trim();
                if (!user3) {
                    log('‚ùå Please enter user3 username', 'error');
                    return;
                }

                log(`üë§ Adding user3 ${user3} to distribution list ${testListName}...`);
                
                const result = await contactManager.addUsernameToDistributionList(testListName, user3);

                if (result.success) {
                    log(`‚úÖ User3 added to distribution list`);
                    document.getElementById('add-user-status').innerHTML = '<span class="success">‚úÖ Added</span>';
                } else {
                    log(`‚ùå Failed to add user: ${result.error}`, 'error');
                    document.getElementById('add-user-status').innerHTML = '<span class="error">‚ùå Failed</span>';
                }
            } catch (error) {
                log(`‚ùå Add user error: ${error.message}`, 'error');
                document.getElementById('add-user-status').innerHTML = '<span class="error">‚ùå Error</span>';
            }
        }

        async function shareWithUpdatedList() {
            try {
                if (!testContact) {
                    log('‚ùå No test contact available.', 'error');
                    return;
                }

                log(`üéØ CRITICAL TEST: Sharing contact with updated list (should share with user3)...`);
                
                const result = await contactManager.shareContactWithDistributionList(
                    testContact.contactId, 
                    testListName
                );

                if (result.success) {
                    log(`‚úÖ FIXED! Contact shared with updated list: ${result.successCount} users, ${result.errorCount} errors`);
                    if (result.successCount > 0) {
                        log(`üéâ SUCCESS: user3 should now have access to the contact!`);
                        document.getElementById('final-share-status').innerHTML = '<span class="success">‚úÖ Fixed!</span>';
                    } else {
                        log(`‚ö†Ô∏è No new shares made - check if users were already shared with`);
                        document.getElementById('final-share-status').innerHTML = '<span class="info">‚ö†Ô∏è No new shares</span>';
                    }
                } else {
                    log(`‚ùå Final share failed: ${result.error}`, 'error');
                    document.getElementById('final-share-status').innerHTML = '<span class="error">‚ùå Failed</span>';
                }
            } catch (error) {
                log(`‚ùå Final share error: ${error.message}`, 'error');
                document.getElementById('final-share-status').innerHTML = '<span class="error">‚ùå Error</span>';
            }
        }

        async function checkDatabases() {
            try {
                log('üîç Checking shared databases...');
                const databases = await userbase.getDatabases();
                const dbList = databases.databases || databases;
                
                log(`üìä Total databases: ${dbList.length}`);
                
                dbList.forEach(db => {
                    if (db.databaseName.startsWith('shared-contact-')) {
                        log(`üì¶ Shared DB: ${db.databaseName} (owner: ${db.isOwner}, users: ${db.users?.length || 'unknown'})`);
                    }
                });
                
            } catch (error) {
                log(`‚ùå Database check error: ${error.message}`, 'error');
            }
        }

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Initialize on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>