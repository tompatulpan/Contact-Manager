<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Test</title>
</head>
<body>
    <h1>Testing Contact Search</h1>
    <div id="test-results"></div>

    <script type="module">
        // Import modules
        import { ContactManager } from './src/core/ContactManager.js';
        import { VCardStandard } from './src/core/VCardStandard.js';
        import { ContactValidator } from './src/core/ContactValidator.js';
        import { EventBus } from './src/utils/EventBus.js';

        // Mock database
        class MockDatabase {
            constructor() {
                this.currentUser = { userId: 'test-user', username: 'testuser' };
                this.contacts = [];
            }
            
            async saveContact(contact) {
                this.contacts.push(contact);
                return { success: true };
            }
            
            async updateContact(contact) {
                const index = this.contacts.findIndex(c => c.contactId === contact.contactId);
                if (index !== -1) {
                    this.contacts[index] = contact;
                }
                return { success: true };
            }
            
            async logActivity() {
                return { success: true };
            }
        }

        async function testSearch() {
            const results = document.getElementById('test-results');
            
            try {
                // Initialize components
                const eventBus = new EventBus();
                const vCardStandard = new VCardStandard();
                const validator = new ContactValidator();
                const database = new MockDatabase();
                
                const contactManager = new ContactManager(eventBus, database, vCardStandard, validator);
                
                // Create test contact
                const contactData = {
                    fn: 'John Doe',
                    cardName: 'Test Contact',
                    phones: [{ value: '123-456-7890', type: 'work', primary: true }],
                    emails: [{ value: 'john@test.com', type: 'work', primary: true }]
                };
                
                const createResult = await contactManager.createContact(contactData);
                if (!createResult.success) {
                    results.innerHTML = `<p style="color: red;">Failed to create test contact: ${createResult.error}</p>`;
                    return;
                }
                
                // Test search
                const searchResults = contactManager.searchContacts('John');
                
                if (searchResults.length === 1) {
                    results.innerHTML = `
                        <p style="color: green;">✅ Search test PASSED!</p>
                        <p>Found ${searchResults.length} contact(s)</p>
                        <p>Contact: ${searchResults[0].cardName}</p>
                    `;
                } else {
                    results.innerHTML = `
                        <p style="color: red;">❌ Search test FAILED!</p>
                        <p>Expected 1 contact, found ${searchResults.length}</p>
                    `;
                }
                
            } catch (error) {
                results.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                console.error('Test error:', error);
            }
        }

        // Run test when page loads
        testSearch();
    </script>
</body>
</html>