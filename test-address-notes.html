<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Address and Notes Support</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-output {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .test-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Address and Notes Support Test</h1>
        
        <div class="test-section">
            <h2>Test Contact with Address and Notes</h2>
            <button class="test-button" onclick="testCreateContactWithAddress()">Create Test Contact</button>
            <button class="test-button" onclick="testVCardGeneration()">Test vCard Generation</button>
            <button class="test-button" onclick="testVCardParsing()">Test vCard Parsing</button>
            <button class="test-button" onclick="testAddressFormatting()">Test Address Formatting</button>
            <button class="test-button" onclick="clearOutput()">Clear Output</button>
        </div>

        <div id="test-output" class="test-output">
Test output will appear here...
        </div>
    </div>

    <!-- Include required modules -->
    <script src="src/utils/EventBus.js"></script>
    <script src="src/core/VCardStandard.js"></script>
    <script src="src/core/ContactValidator.js"></script>
    <script src="src/core/ContactDatabase.js"></script>
    <script src="src/core/ContactManager.js"></script>

    <script>
        let eventBus, vCardStandard, contactManager;

        // Initialize components
        function initializeTest() {
            eventBus = new EventBus();
            vCardStandard = new VCardStandard();
            contactManager = new ContactManager(eventBus, null); // No database for testing
            
            log('✅ Test environment initialized');
        }

        function log(message) {
            const output = document.getElementById('test-output');
            output.textContent += new Date().toISOString() + ': ' + message + '\n';
        }

        function clearOutput() {
            document.getElementById('test-output').textContent = 'Test output cleared...\n';
        }

        // Test creating a contact with address and notes
        function testCreateContactWithAddress() {
            log('\n=== Testing Contact Creation with Address and Notes ===');
            
            const testContactData = {
                fn: 'John Smith',
                cardName: 'John - Test Contact',
                organization: 'Test Company Inc.',
                title: 'Software Engineer',
                phones: [
                    { value: '+1-555-123-4567', type: 'work', primary: true },
                    { value: '+1-555-987-6543', type: 'mobile', primary: false }
                ],
                emails: [
                    { value: 'john.smith@testcompany.com', type: 'work', primary: true },
                    { value: 'john@personal.com', type: 'home', primary: false }
                ],
                urls: [
                    { value: 'https://www.testcompany.com', type: 'work', primary: true }
                ],
                addresses: [
                    {
                        street: '123 Main Street',
                        city: 'San Francisco',
                        state: 'CA',
                        postalCode: '94102',
                        country: 'USA',
                        type: 'work',
                        primary: true
                    },
                    {
                        street: '456 Oak Avenue',
                        city: 'Berkeley',
                        state: 'CA',
                        postalCode: '94704',
                        country: 'USA',
                        type: 'home',
                        primary: false
                    }
                ],
                notes: [
                    'Important client contact - handles all technical decisions',
                    'Prefers email communication over phone calls'
                ]
            };

            try {
                const vCard = vCardStandard.generateVCard(testContactData);
                log('✅ vCard generated successfully');
                log('Generated vCard:');
                log(vCard);
                
                // Test parsing the generated vCard
                const parsed = vCardStandard.parseVCard(vCard);
                log('✅ vCard parsed successfully');
                log('Parsed addresses: ' + JSON.stringify(parsed.addresses, null, 2));
                log('Parsed notes: ' + JSON.stringify(parsed.notes, null, 2));
                
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        }

        // Test vCard generation with addresses
        function testVCardGeneration() {
            log('\n=== Testing vCard Generation ===');
            
            const contactData = {
                fn: 'Jane Doe',
                addresses: [
                    {
                        street: '789 Business Blvd',
                        city: 'New York',
                        state: 'NY', 
                        postalCode: '10001',
                        country: 'United States',
                        type: 'work',
                        primary: true
                    }
                ],
                notes: ['VIP Customer', 'Requires special handling']
            };

            try {
                const vCard = vCardStandard.generateVCard(contactData);
                log('Generated vCard with address and notes:');
                log(vCard);

                // Verify address formatting
                const hasAddress = vCard.includes('ADR;TYPE=work;PREF=1:;;789 Business Blvd;New York;NY;10001;United States');
                const hasNotes = vCard.includes('NOTE:VIP Customer') && vCard.includes('NOTE:Requires special handling');
                
                log('✅ Address formatting: ' + (hasAddress ? 'CORRECT' : 'INCORRECT'));
                log('✅ Notes formatting: ' + (hasNotes ? 'CORRECT' : 'INCORRECT'));
                
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        }

        // Test vCard parsing with addresses
        function testVCardParsing() {
            log('\n=== Testing vCard Parsing ===');
            
            const testVCard = `BEGIN:VCARD
VERSION:4.0
FN:Test User
TEL;TYPE=work;PREF=1:+1-555-123-4567
EMAIL;TYPE=work;PREF=1:test@company.com
ADR;TYPE=work;PREF=1:PO Box 123;;123 Main St;San Francisco;CA;94102;USA
ADR;TYPE=home:;;456 Oak Ave;Berkeley;CA;94704;USA
NOTE:This is a test contact
NOTE:Multiple notes are supported
ORG:Test Company
TITLE:Engineer
END:VCARD`;

            try {
                const parsed = vCardStandard.parseVCard(testVCard);
                log('✅ vCard parsed successfully');
                log('Full name: ' + parsed.properties.get('FN'));
                log('Organization: ' + parsed.properties.get('ORG'));
                log('Title: ' + parsed.properties.get('TITLE'));
                log('Addresses found: ' + (parsed.addresses ? parsed.addresses.length : 0));
                log('Notes found: ' + (parsed.notes ? parsed.notes.length : 0));
                
                if (parsed.addresses) {
                    parsed.addresses.forEach((addr, index) => {
                        log(`Address ${index + 1}: ${addr.street}, ${addr.city}, ${addr.state} ${addr.postalCode} (${addr.type})`);
                    });
                }
                
                if (parsed.notes) {
                    parsed.notes.forEach((note, index) => {
                        log(`Note ${index + 1}: ${note}`);
                    });
                }
                
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        }

        // Test address formatting methods
        function testAddressFormatting() {
            log('\n=== Testing Address Formatting Methods ===');
            
            const testAddress = {
                street: '123 Test Street',
                city: 'Test City', 
                state: 'TS',
                postalCode: '12345',
                country: 'Test Country',
                type: 'work',
                primary: true
            };

            try {
                const formatted = vCardStandard.formatAddressValue(testAddress);
                log('Formatted address: ' + formatted);
                
                // Test parsing it back
                const parsed = vCardStandard.parseAddressValue(formatted);
                log('Parsed back - Street: ' + parsed.street);
                log('Parsed back - City: ' + parsed.city);
                log('Parsed back - State: ' + parsed.state);
                log('Parsed back - Postal: ' + parsed.postalCode);
                log('Parsed back - Country: ' + parsed.country);
                
                // Verify round-trip accuracy
                const isAccurate = 
                    parsed.street === testAddress.street &&
                    parsed.city === testAddress.city &&
                    parsed.state === testAddress.state &&
                    parsed.postalCode === testAddress.postalCode &&
                    parsed.country === testAddress.country;
                    
                log('✅ Round-trip accuracy: ' + (isAccurate ? 'PASSED' : 'FAILED'));
                
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', initializeTest);
    </script>
</body>
</html>