<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Data Cleanup Utility</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .cleanup-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .cleanup-output {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .cleanup-button {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .cleanup-button:hover {
            background: #c82333;
        }
        .info-button {
            background: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .info-button:hover {
            background: #138496;
        }
        .size-warning {
            color: #856404;
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .size-error {
            color: #721c24;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .size-ok {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="cleanup-container">
        <h1>Contact Data Cleanup Utility</h1>
        
        <div class="info-section">
            <h2>Purpose</h2>
            <p>This utility helps identify and clean up contacts that are approaching or exceeding the 10KB Userbase storage limit.</p>
            
            <div class="size-warning">
                <strong>‚ö†Ô∏è Size Limits:</strong><br>
                ‚Ä¢ Userbase limit: 10KB per contact<br>
                ‚Ä¢ Warning threshold: 7KB (yellow)<br>
                ‚Ä¢ Critical threshold: 9KB (red)<br>
                ‚Ä¢ Clean up automatically removes excess interaction history
            </div>
        </div>
        
        <div class="action-section">
            <h2>Actions</h2>
            <button class="info-button" onclick="analyzeContacts()">Analyze Contact Sizes</button>
            <button class="cleanup-button" onclick="cleanupLargeContacts()">Cleanup Large Contacts</button>
            <button class="info-button" onclick="showDetailedSizes()">Show Detailed Breakdown</button>
            <button class="info-button" onclick="clearOutput()">Clear Output</button>
        </div>

        <div id="cleanup-output" class="cleanup-output">
Cleanup utility ready...
        </div>
    </div>

    <!-- Include required modules -->
    <script src="src/utils/EventBus.js"></script>
    <script src="src/core/VCardStandard.js"></script>
    <script src="src/core/ContactValidator.js"></script>
    <script src="src/core/ContactDatabase.js"></script>
    <script src="src/core/ContactManager.js"></script>

    <script>
        let eventBus, contactManager, database;

        // Initialize components
        async function initializeCleanup() {
            try {
                eventBus = new EventBus();
                database = new ContactDatabase(eventBus);
                contactManager = new ContactManager(eventBus, database);
                
                // Initialize database
                await database.initialize();
                
                log('‚úÖ Cleanup utility initialized');
                log('üìä Contact manager ready with ' + contactManager.contacts.size + ' contacts');
                
            } catch (error) {
                log('‚ùå Initialization error: ' + error.message);
            }
        }

        function log(message) {
            const output = document.getElementById('cleanup-output');
            output.textContent += new Date().toISOString() + ': ' + message + '\n';
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('cleanup-output').textContent = 'Output cleared...\n';
        }

        // Analyze contact sizes
        function analyzeContacts() {
            log('\n=== Contact Size Analysis ===');
            
            const contacts = Array.from(contactManager.contacts.values());
            if (contacts.length === 0) {
                log('No contacts found');
                return;
            }

            let totalContacts = contacts.length;
            let warningCount = 0;
            let errorCount = 0;
            let okCount = 0;

            contacts.forEach(contact => {
                const validation = contactManager.validateContactSize(contact);
                
                if (!validation.isValid) {
                    errorCount++;
                    log(`‚ùå ${contact.cardName} (${contact.contactId}): ${validation.sizeInKB}KB - TOO LARGE`);
                } else if (validation.warning) {
                    warningCount++;
                    log(`‚ö†Ô∏è ${contact.cardName} (${contact.contactId}): ${validation.sizeInKB}KB - ${validation.warning}`);
                } else {
                    okCount++;
                    log(`‚úÖ ${contact.cardName} (${contact.contactId}): ${validation.sizeInKB}KB - OK`);
                }
            });

            log('\nüìä Summary:');
            log(`Total contacts: ${totalContacts}`);
            log(`OK (< 7KB): ${okCount}`);
            log(`Warning (7-9KB): ${warningCount}`);
            log(`Error (> 9KB): ${errorCount}`);
        }

        // Clean up large contacts
        async function cleanupLargeContacts() {
            log('\n=== Cleaning Up Large Contacts ===');
            
            const contacts = Array.from(contactManager.contacts.values());
            let cleanedCount = 0;
            
            for (const contact of contacts) {
                const validation = contactManager.validateContactSize(contact);
                
                if (!validation.isValid || validation.warning) {
                    log(`üßπ Cleaning up: ${contact.cardName} (${validation.sizeInKB}KB)`);
                    
                    try {
                        const cleanedContact = contactManager.cleanupContactMetadata(contact);
                        const newValidation = contactManager.validateContactSize(cleanedContact);
                        
                        if (newValidation.isValid) {
                            // Update the contact in the database
                            await database.updateContact(cleanedContact);
                            contactManager.contacts.set(contact.contactId, cleanedContact);
                            
                            log(`‚úÖ Cleaned: ${contact.cardName} - ${validation.sizeInKB}KB ‚Üí ${newValidation.sizeInKB}KB`);
                            cleanedCount++;
                        } else {
                            log(`‚ùå Still too large after cleanup: ${contact.cardName} (${newValidation.sizeInKB}KB)`);
                        }
                    } catch (error) {
                        log(`‚ùå Error cleaning ${contact.cardName}: ${error.message}`);
                    }
                }
            }
            
            log(`\nüéâ Cleanup complete! Cleaned ${cleanedCount} contacts.`);
        }

        // Show detailed size breakdown
        function showDetailedSizes() {
            log('\n=== Detailed Size Breakdown ===');
            
            const contacts = Array.from(contactManager.contacts.values());
            
            contacts.forEach(contact => {
                const validation = contactManager.validateContactSize(contact);
                
                // Break down the size components
                const vCardSize = new Blob([contact.vcard || '']).size;
                const metadataSize = new Blob([JSON.stringify(contact.metadata || {})]).size;
                const cardNameSize = new Blob([contact.cardName || '']).size;
                
                log(`\nüìã ${contact.cardName} (${contact.contactId}):`);
                log(`  Total: ${validation.sizeInKB}KB (${validation.sizeInBytes} bytes)`);
                log(`  vCard: ${Math.round(vCardSize / 1024 * 100) / 100}KB`);
                log(`  Metadata: ${Math.round(metadataSize / 1024 * 100) / 100}KB`);
                log(`  Card Name: ${Math.round(cardNameSize / 1024 * 100) / 100}KB`);
                
                if (contact.metadata?.usage?.interactionHistory) {
                    const historySize = new Blob([JSON.stringify(contact.metadata.usage.interactionHistory)]).size;
                    log(`  Interaction History: ${Math.round(historySize / 1024 * 100) / 100}KB (${contact.metadata.usage.interactionHistory.length} items)`);
                }
                
                if (contact.metadata?.sharing?.shareHistory) {
                    const shareHistorySize = new Blob([JSON.stringify(contact.metadata.sharing.shareHistory)]).size;
                    log(`  Share History: ${Math.round(shareHistorySize / 1024 * 100) / 100}KB (${contact.metadata.sharing.shareHistory.length} items)`);
                }
            });
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', initializeCleanup);
    </script>
</body>
</html>